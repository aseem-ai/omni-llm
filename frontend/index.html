<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni-LLM Workbench</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #09090b;
            color: #e4e4e7;
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(39, 39, 42, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #18181b;
        }

        ::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #52525b;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );
        const Brain = (p) => <IconWrapper {...p}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z" /><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z" /></IconWrapper>;
        const Database = (p) => <IconWrapper {...p}><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M3 5V19A9 3 0 0 0 21 19V5" /><path d="M3 12A9 3 0 0 0 21 12" /></IconWrapper>;
        const Layers = (p) => <IconWrapper {...p}><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z" /><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65" /><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65" /></IconWrapper>;
        const Activity = (p) => <IconWrapper {...p}><path d="M22 12h-4l-3 9L9 3l-3 9H2" /></IconWrapper>;
        const Cpu = (p) => <IconWrapper {...p}><rect x="4" y="4" width="16" height="16" rx="2" /><rect x="9" y="9" width="6" height="6" /><path d="M15 2v2" /><path d="M15 20v2" /><path d="M2 15h2" /><path d="M2 9h2" /><path d="M20 15h2" /><path d="M20 9h2" /><path d="M9 2v2" /><path d="M9 20v2" /></IconWrapper>;
        const Zap = (p) => <IconWrapper {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></IconWrapper>;
        const Search = (p) => <IconWrapper {...p}><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></IconWrapper>;

        const App = () => {
            const [useRag, setUseRag] = useState(false);
            const [useLora, setUseLora] = useState(false);
            const [logs, setLogs] = useState([]);
            const [input, setInput] = useState('');
            const [isThinking, setIsThinking] = useState(false);
            const chatEndRef = useRef(null);

            // Stats State
            const [ragDocs, setRagDocs] = useState([]);
            const [probs, setProbs] = useState([
                { token: "Llama", prob: 0.85 },
                { token: "GPT-4", prob: 0.10 },
                { token: "Mistral", prob: 0.05 }
            ]);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [logs]);

            const handleSend = async () => {
                if (!input.trim()) return;

                const userMsg = input;
                setInput('');
                setIsThinking(true);

                const newLogId = Date.now();
                setLogs(prev => [...prev, {
                    id: newLogId,
                    user: userMsg,
                    bot: null,
                    rag: [],
                    lora: useLora
                }]);

                try {
                    // --- REAL API CALL TO BACKEND ---
                    const response = await fetch('https://omni-llm.onrender.com/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: userMsg,
                            use_rag: useRag,
                            use_lora: useLora
                        })
                    });

                    const data = await response.json();

                    // Update state with Real Data from Python
                    setLogs(prev => prev.map(log =>
                        log.id === newLogId
                            ? { ...log, bot: data.response, rag: data.rag_docs, lora: data.meta.lora_active }
                            : log
                    ));

                    if (data.rag_docs) setRagDocs(data.rag_docs);

                    // Simulate stats update for effect (Real stats would come from data.meta)
                    setProbs([
                        { token: "Architecture", prob: 0.72 },
                        { token: "Model", prob: 0.18 },
                        { token: "System", prob: 0.10 }
                    ]);

                } catch (error) {
                    console.error("API Error:", error);
                    setLogs(prev => prev.map(log =>
                        log.id === newLogId
                            ? { ...log, bot: "Error: Could not connect to Omni-LLM Backend (Is uvicorn running on port 8001?)", rag: [] }
                            : log
                    ));
                } finally {
                    setIsThinking(false);
                }
            };

            return (
                <div className="h-screen flex flex-col max-w-7xl mx-auto p-4 gap-4">
                    {/* Header */}
                    <header className="flex justify-between items-center p-4 glass rounded-xl shadow-2xl">
                        <div className="flex items-center gap-4">
                            <div className="p-3 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl shadow-lg shadow-blue-500/20">
                                <Brain color="white" size={24} />
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400 tracking-tight">
                                    Omni-LLM
                                </h1>
                                <div className="flex items-center gap-2 text-xs text-zinc-400 font-mono">
                                    <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                                    SYSTEM ONLINE | 28M PARAMETERS
                                </div>
                            </div>
                        </div>
                        <div className="flex gap-3">
                            <button
                                onClick={() => setUseRag(!useRag)}
                                className={`flex items-center gap-2 px-4 py-2 rounded-lg border text-sm font-medium transition-all duration-300 ${useRag ? 'bg-emerald-500/10 border-emerald-500/50 text-emerald-400 shadow-[0_0_15px_rgba(16,185,129,0.2)]' : 'border-zinc-800 text-zinc-500 hover:border-zinc-700 hover:bg-zinc-900'}`}
                            >
                                <Database size={16} /> RAG {useRag ? 'ON' : 'OFF'}
                            </button>
                            <button
                                onClick={() => setUseLora(!useLora)}
                                className={`flex items-center gap-2 px-4 py-2 rounded-lg border text-sm font-medium transition-all duration-300 ${useLora ? 'bg-purple-500/10 border-purple-500/50 text-purple-400 shadow-[0_0_15px_rgba(168,85,247,0.2)]' : 'border-zinc-800 text-zinc-500 hover:border-zinc-700 hover:bg-zinc-900'}`}
                            >
                                <Layers size={16} /> LoRA {useLora ? 'ACTIVE' : 'INACTIVE'}
                            </button>
                        </div>
                    </header>

                    <div className="flex-1 grid grid-cols-12 gap-4 min-h-0">
                        {/* Main Chat Area */}
                        <div className="col-span-8 glass rounded-xl flex flex-col overflow-hidden relative border border-zinc-800/50">
                            <div className="flex-1 overflow-y-auto p-6 space-y-8">
                                {logs.length === 0 && (
                                    <div className="h-full flex flex-col items-center justify-center text-zinc-600 gap-4 opacity-50">
                                        <div className="p-4 rounded-full bg-zinc-900/50 border border-zinc-800">
                                            <Activity size={48} />
                                        </div>
                                        <p className="font-mono text-sm">Initialize sequence...</p>
                                    </div>
                                )}
                                {logs.map((log) => (
                                    <div key={log.id} className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                        <div className="flex justify-end">
                                            <div className="bg-zinc-800 text-zinc-100 px-5 py-3 rounded-2xl rounded-tr-sm max-w-[80%] shadow-lg">
                                                {log.user}
                                            </div>
                                        </div>
                                        {(log.bot || isThinking) && (
                                            <div className="flex justify-start">
                                                <div className={`px-5 py-3 rounded-2xl rounded-tl-sm max-w-[80%] border backdrop-blur-sm shadow-lg transition-all ${log.lora ? 'bg-purple-950/20 border-purple-500/30 shadow-purple-900/10' : 'bg-blue-950/20 border-blue-500/30 shadow-blue-900/10'}`}>
                                                    {log.bot ? (
                                                        <p className="leading-relaxed text-zinc-200">{log.bot}</p>
                                                    ) : (
                                                        <div className="flex items-center gap-2 text-zinc-400">
                                                            <span className="animate-spin"><Cpu size={16} /></span>
                                                            <span className="text-xs font-mono animate-pulse">GENERATING TOKENS...</span>
                                                        </div>
                                                    )}
                                                    {log.rag && log.rag.length > 0 && (
                                                        <div className="mt-3 pt-3 border-t border-white/5 space-y-2">
                                                            <div className="flex items-center gap-2 text-[10px] text-zinc-500 font-bold tracking-wider uppercase">
                                                                <Search size={12} /> Sources Retrieved
                                                            </div>
                                                            {log.rag.map((doc, idx) => (
                                                                <div key={idx} className="flex gap-2 items-start text-xs text-zinc-400 bg-black/20 p-2 rounded border border-white/5">
                                                                    <div className="mt-0.5 min-w-[3px] h-3 bg-emerald-500 rounded-full"></div>
                                                                    <span>{doc.text}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                                <div ref={chatEndRef} />
                            </div>
                            <div className="p-4 bg-zinc-900/80 border-t border-zinc-800 backdrop-blur-xl">
                                <div className="flex gap-3">
                                    <input
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                                        placeholder="Ask about Llama 3 architecture, RoPE, or GQA..."
                                        className="flex-1 bg-zinc-950 border border-zinc-700/50 rounded-xl px-5 py-4 focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/20 transition-all placeholder:text-zinc-600"
                                    />
                                    <button
                                        onClick={handleSend}
                                        disabled={isThinking || !input}
                                        className={`px-6 rounded-xl font-semibold transition-all flex items-center gap-2 ${isThinking || !input ? 'bg-zinc-800 text-zinc-500 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-600/20 hover:scale-105 active:scale-95'}`}
                                    >
                                        <Zap size={20} fill={input ? "currentColor" : "none"} />
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Right Sidebar: Internals Monitor */}
                        <div className="col-span-4 flex flex-col gap-4 min-h-0">
                            <div className="glass rounded-xl p-5 flex-1 flex flex-col border border-zinc-800/50">
                                <h3 className="text-sm font-bold text-zinc-400 mb-4 flex items-center gap-2 uppercase tracking-wider">
                                    <Database size={16} /> Vector Store
                                </h3>
                                <div className="flex-1 bg-zinc-950/30 rounded-lg p-2 overflow-y-auto space-y-2 border border-white/5">
                                    {ragDocs.length === 0 ? (
                                        <div className="h-full flex flex-col items-center justify-center text-zinc-700 space-y-2">
                                            <Database size={32} strokeWidth={1} />
                                            <p className="text-xs">No context retrieved</p>
                                        </div>
                                    ) : (
                                        ragDocs.map((doc, i) => (
                                            <div key={i} className="bg-zinc-900/80 p-3 rounded border border-zinc-800 hover:border-emerald-500/30 transition-colors group">
                                                <div className="flex justify-between text-[10px] text-zinc-500 mb-1.5 font-mono">
                                                    <span>CHUNK_{i + 1024}</span>
                                                    <span className="text-emerald-500 font-bold bg-emerald-500/10 px-1 rounded">{doc.score.toFixed(3)} SIM</span>
                                                </div>
                                                <p className="text-xs text-zinc-300 leading-snug group-hover:text-white transition-colors">{doc.text}</p>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                            <div className="glass rounded-xl p-5 h-[35%] flex flex-col border border-zinc-800/50">
                                <h3 className="text-sm font-bold text-zinc-400 mb-4 flex items-center gap-2 uppercase tracking-wider">
                                    <Activity size={16} /> Softmax Output
                                </h3>
                                <div className="space-y-3">
                                    {probs.map((p, i) => (
                                        <div key={i} className="group">
                                            <div className="flex justify-between text-xs mb-1">
                                                <span className="font-mono text-zinc-400 group-hover:text-blue-400 transition-colors">token_{i}: "{p.token}"</span>
                                                <span className="text-zinc-500 font-mono">{(p.prob * 100).toFixed(1)}%</span>
                                            </div>
                                            <div className="h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                                                <div
                                                    className="h-full bg-gradient-to-r from-blue-600 to-cyan-500 rounded-full transition-all duration-500"
                                                    style={{ width: `${p.prob * 100}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>